import React, { useState, useEffect, useMemo } from 'react';
import { ChevronLeft, ChevronRight, TrendingUp, Trophy, Activity, Plus, Trash2, Loader2, Leaf, Skull, Check, X, ShieldCheck } from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, addDoc, serverTimestamp } from "firebase/firestore";

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function App() {
  // Auth State
  const [user, setUser] = useState(null);
  
  // App State
  const [currentDate, setCurrentDate] = useState(new Date());
  const [habits, setHabits] = useState([]);
  const [trackerData, setTrackerData] = useState({});
  const [loading, setLoading] = useState(true);
  const [newHabitText, setNewHabitText] = useState("");
  const [newHabitType, setNewHabitType] = useState('good'); // 'good' or 'bad'

  // --- 1. Authentication Effect ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed:", error);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // --- 2. Data Fetching Effect (Real-time) ---
  useEffect(() => {
    if (!user) return;

    // A. Fetch Habits
    const habitsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'habits');
    const unsubHabits = onSnapshot(habitsRef, (snapshot) => {
      const loadedHabits = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      loadedHabits.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
      setHabits(loadedHabits);
      setLoading(false);
    }, (error) => console.error("Habits listener error:", error));

    // B. Fetch Completions
    const completionsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'completions');
    const unsubCompletions = onSnapshot(completionsRef, (snapshot) => {
      const data = {};
      snapshot.docs.forEach(doc => {
        data[doc.id] = true;
      });
      setTrackerData(data);
    }, (error) => console.error("Completions listener error:", error));

    return () => {
      unsubHabits();
      unsubCompletions();
    };
  }, [user]);


  // --- Actions ---

  const handleAddHabit = async (e) => {
    e.preventDefault();
    if (!newHabitText.trim() || !user) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'habits'), {
        label: newHabitText,
        type: newHabitType,
        createdAt: serverTimestamp()
      });
      setNewHabitText("");
    } catch (err) {
      console.error("Error adding habit:", err);
    }
  };

  const handleDeleteHabit = async (habitId) => {
    if (!user) return;
    if (confirm("Delete this habit?")) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'habits', habitId));
      } catch (err) {
        console.error("Error deleting habit:", err);
      }
    }
  };

  const toggleHabit = async (day, habitId) => {
    if (!user) return;
    
    const key = `${year}-${month}-${day}_${habitId}`;
    const isDone = !!trackerData[key];
    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'completions', key);

    try {
      if (isDone) {
        await deleteDoc(ref);
      } else {
        await setDoc(ref, {
          habitId,
          day,
          month,
          year,
          completedAt: serverTimestamp()
        });
      }
    } catch (err) {
      console.error("Error toggling habit:", err);
    }
  };

  const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
  const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

  // --- Calculations ---
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const monthName = currentDate.toLocaleString('default', { month: 'long' });
  const currentDayNum = new Date().getDate();
  const isCurrentMonth = new Date().getMonth() === month && new Date().getFullYear() === year;

  const isCompleted = (day, habitId) => {
    const key = `${year}-${month}-${day}_${habitId}`;
    return !!trackerData[key];
  };

  // Helpers to split habits
  const goodHabits = habits.filter(h => (h.type || 'good') === 'good');
  const badHabits = habits.filter(h => h.type === 'bad');

  const getDailyStats = (day) => {
    let goodDone = 0;
    let badDone = 0;

    goodHabits.forEach(habit => {
      if (isCompleted(day, habit.id)) goodDone++;
    });
    badHabits.forEach(habit => {
      if (isCompleted(day, habit.id)) badDone++;
    });

    const totalGood = goodHabits.length || 1;
    const percent = Math.round((goodDone / totalGood) * 100);

    return { goodDone, badDone, percent };
  };

  const trendData = useMemo(() => {
    return Array.from({ length: daysInMonth }, (_, i) => {
      const day = i + 1;
      return getDailyStats(day).percent;
    });
  }, [trackerData, month, year, daysInMonth, habits]);

  const badHabitTrendData = useMemo(() => {
    return Array.from({ length: daysInMonth }, (_, i) => {
      const day = i + 1;
      return getDailyStats(day).badDone;
    });
  }, [trackerData, month, year, daysInMonth, habits]);

  // Chart Logic (Good Habits)
  const getTrendPath = () => {
    if (trendData.length === 0) return "";
    const maxVal = 100;
    const width = 260; // Internal coordinate system width
    const height = 100; // Internal coordinate system height
    const stepX = width / (daysInMonth - 1 || 1);
    
    const points = trendData.map((val, i) => {
      const x = i * stepX;
      const y = height - (val / maxVal) * height;
      return `${x},${y}`;
    }).join(' ');
    
    return `M0,${height} L${points} L${width},${height} Z`;
  };
  
  const getTrendLine = () => {
    if (trendData.length === 0) return "";
    const maxVal = 100;
    const width = 260;
    const height = 100;
    const stepX = width / (daysInMonth - 1 || 1);
    
    const points = trendData.map((val, i) => {
      const x = i * stepX;
      const y = height - (val / maxVal) * height;
      return `${x},${y}`;
    }).join(' ');
    return `M${points}`;
  };

  // Top Habit Logic
  const bestHabit = useMemo(() => {
    if (goodHabits.length === 0) return { label: "No Data", score: 0 };
    let best = { ...goodHabits[0], score: 0 };
    goodHabits.forEach(habit => {
      let count = 0;
      for (let d = 1; d <= daysInMonth; d++) {
        if (isCompleted(d, habit.id)) count++;
      }
      const score = Math.round((count / daysInMonth) * 100);
      if (score > best.score) {
        best = { ...habit, score };
      }
    });
    return best;
  }, [trackerData, month, year, daysInMonth, goodHabits]);

  const totalGoodHabits = goodHabits.length;
  const totalCells = daysInMonth * totalGoodHabits;
  const totalCompleted = Array.from({ length: daysInMonth }, (_, i) => i + 1)
    .reduce((acc, day) => acc + getDailyStats(day).goodDone, 0);
  const monthlyCompletionRate = (totalCells > 0) ? Math.round((totalCompleted / totalCells) * 100) : 0;

  const totalIncidents = badHabitTrendData.reduce((a, b) => a + b, 0);

  // --- Render ---

  if (loading && !user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-zinc-50 text-zinc-600">
        <Loader2 className="w-8 h-8 animate-spin text-zinc-900" />
        <span className="ml-2 font-medium text-sm">Syncing...</span>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-zinc-50 p-2 sm:p-8 font-sans flex flex-col items-center text-zinc-900">
      
      <div className="w-full max-w-[1400px] bg-white rounded-xl sm:rounded-2xl shadow-sm border border-zinc-200 overflow-hidden flex flex-col mb-6 sm:mb-8 transition-all">
        
        {/* Header */}
        <div className="px-4 py-4 sm:px-6 sm:py-5 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 border-b border-zinc-100">
          <div className="flex items-center gap-4">
            <div>
              <h1 className="text-xl sm:text-2xl font-bold tracking-tight text-zinc-900">
                {monthName} Tracker
              </h1>
              <p className="text-xs text-zinc-500 font-medium mt-0.5">
                {user ? 'Sync Active' : 'Offline'} â€¢ {year}
              </p>
            </div>
            <span className="hidden sm:inline-flex bg-zinc-100 text-zinc-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border border-zinc-200">
              Monk Mode
            </span>
          </div>

          <div className="flex items-center gap-1 bg-zinc-100/80 p-1 rounded-lg border border-zinc-200">
            <button onClick={prevMonth} className="p-1.5 hover:bg-white hover:shadow-sm rounded-md transition-all text-zinc-500 hover:text-zinc-900" aria-label="Previous Month">
              <ChevronLeft className="w-4 h-4" />
            </button>
            <span className="text-xs font-bold text-zinc-700 px-3 min-w-[60px] text-center tabular-nums">{year}</span>
            <button onClick={nextMonth} className="p-1.5 hover:bg-white hover:shadow-sm rounded-md transition-all text-zinc-500 hover:text-zinc-900" aria-label="Next Month">
              <ChevronRight className="w-4 h-4" />
            </button>
          </div>
        </div>

        {/* Grid Container - Mobile Optimized with Sticky Column */}
        <div className="w-full overflow-hidden relative">
          <div className="overflow-x-auto scrollbar-hide">
            <div className="min-w-max">
              
              {/* Grid Header - Days */}
              <div className="flex border-b border-zinc-200 bg-zinc-50/50 sticky top-0 z-40 backdrop-blur-sm">
                {/* Sticky 'Habits' Label Cell */}
                <div className="w-32 sm:w-64 flex-shrink-0 p-3 font-semibold text-zinc-500 text-[10px] sm:text-xs pl-4 sm:pl-6 flex items-end pb-2 bg-zinc-50/95 sticky left-0 z-50 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.1)]">
                  HABITS
                </div>
                
                {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => (
                  <div key={day} className={`w-10 flex-shrink-0 flex flex-col items-center justify-end pb-2 border-l border-zinc-100 font-medium text-xs ${day === currentDayNum && isCurrentMonth ? 'text-indigo-600 font-bold' : 'text-zinc-500'}`}>
                    {day}
                    {day === currentDayNum && isCurrentMonth && <div className="h-1 w-1 bg-indigo-600 rounded-full mt-1"></div>}
                  </div>
                ))}
              </div>

              {/* --- GOOD HABITS SECTION --- */}
              {goodHabits.length > 0 && (
                <div className="group/section">
                  <div className="flex bg-emerald-50/40 border-b border-emerald-100/50 sticky left-0 z-30">
                    {/* Sticky Header for Section */}
                    <div className="w-32 sm:w-64 flex-shrink-0 py-2 px-4 sm:px-6 text-[10px] font-bold text-emerald-700/80 uppercase tracking-widest flex items-center gap-2 bg-emerald-50/95 sticky left-0 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.05)]">
                      <Leaf className="w-3 h-3" /> <span className="hidden sm:inline">Building</span><span className="sm:hidden">Build</span>
                    </div>
                    {/* Spacer for the rest of the row */}
                    <div className="flex-1 min-w-[1000px]"></div> 
                  </div>

                  {goodHabits.map((habit, idx) => (
                    <div key={habit.id} className={`flex border-b border-zinc-100 hover:bg-zinc-50 transition-colors group/row ${idx === goodHabits.length - 1 ? 'border-b-0' : ''}`}>
                      {/* Sticky Habit Name Cell */}
                      <div className="w-32 sm:w-64 flex-shrink-0 p-2 sm:p-3 text-zinc-700 text-xs sm:text-sm font-medium pl-4 sm:pl-6 flex items-center justify-between pr-2 sm:pr-4 border-l-2 border-transparent hover:border-emerald-400 transition-all bg-white sticky left-0 z-30 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.05)]">
                        <span className="truncate">{habit.label}</span>
                        <button onClick={() => handleDeleteHabit(habit.id)} className="hidden sm:block opacity-0 group-hover/row:opacity-100 text-zinc-300 hover:text-red-500 transition-all p-1">
                          <Trash2 className="w-3.5 h-3.5" />
                        </button>
                        {/* Mobile Delete (Always visible if needed, or handled via long press - keep simple for now) */}
                        <button onClick={() => handleDeleteHabit(habit.id)} className="sm:hidden text-zinc-200 hover:text-red-500 p-1">
                           <Trash2 className="w-3 h-3" />
                        </button>
                      </div>

                      {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => {
                        const checked = isCompleted(day, habit.id);
                        return (
                          <div key={day} className="w-10 flex-shrink-0 border-l border-zinc-100 flex items-center justify-center py-2.5 bg-white group-hover/row:bg-zinc-50/50 transition-colors">
                            <button
                              onClick={() => toggleHabit(day, habit.id)}
                              className={`
                                w-6 h-6 rounded-md transition-all duration-200 flex items-center justify-center border
                                focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:ring-offset-1
                                ${checked 
                                  ? 'bg-emerald-500 border-emerald-600 text-white shadow-sm shadow-emerald-200 hover:bg-emerald-600 hover:scale-105' 
                                  : 'bg-white border-zinc-200 text-transparent hover:border-emerald-300 hover:bg-emerald-50/30'
                                }
                              `}
                            >
                              <Check className={`w-3.5 h-3.5 transition-transform duration-300 ${checked ? 'scale-100' : 'scale-50'}`} strokeWidth={3} />
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>
              )}

              {/* --- BAD HABITS SECTION --- */}
              {badHabits.length > 0 && (
                <div className="group/section border-t border-zinc-200">
                  <div className="flex bg-rose-50/40 border-b border-rose-100/50 sticky left-0 z-30">
                     <div className="w-32 sm:w-64 flex-shrink-0 py-2 px-4 sm:px-6 text-[10px] font-bold text-rose-700/80 uppercase tracking-widest flex items-center gap-2 bg-rose-50/95 sticky left-0 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.05)]">
                      <Skull className="w-3 h-3" /> <span className="hidden sm:inline">Breaking</span><span className="sm:hidden">Break</span>
                    </div>
                    <div className="flex-1 min-w-[1000px]"></div>
                  </div>
                  {badHabits.map((habit, idx) => (
                    <div key={habit.id} className="flex border-b border-zinc-100 hover:bg-zinc-50 transition-colors group/row">
                      <div className="w-32 sm:w-64 flex-shrink-0 p-2 sm:p-3 text-zinc-700 text-xs sm:text-sm font-medium pl-4 sm:pl-6 flex items-center justify-between pr-2 sm:pr-4 border-l-2 border-transparent hover:border-rose-400 transition-all bg-white sticky left-0 z-30 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.05)]">
                        <span className="truncate">{habit.label}</span>
                        <button onClick={() => handleDeleteHabit(habit.id)} className="hidden sm:block opacity-0 group-hover/row:opacity-100 text-zinc-300 hover:text-red-500 transition-all p-1">
                          <Trash2 className="w-3.5 h-3.5" />
                        </button>
                         <button onClick={() => handleDeleteHabit(habit.id)} className="sm:hidden text-zinc-200 hover:text-red-500 p-1">
                           <Trash2 className="w-3 h-3" />
                        </button>
                      </div>
                      {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => {
                        const checked = isCompleted(day, habit.id);
                        return (
                          <div key={day} className="w-10 flex-shrink-0 border-l border-zinc-100 flex items-center justify-center py-2.5 bg-white group-hover/row:bg-zinc-50/50 transition-colors">
                            <button
                              onClick={() => toggleHabit(day, habit.id)}
                              className={`
                                w-6 h-6 rounded-md transition-all duration-200 flex items-center justify-center border
                                focus:outline-none focus:ring-2 focus:ring-rose-500/20 focus:ring-offset-1
                                ${checked 
                                  ? 'bg-rose-500 border-rose-600 text-white shadow-sm shadow-rose-200 hover:bg-rose-600 hover:scale-105' 
                                  : 'bg-white border-zinc-200 text-transparent hover:border-rose-300 hover:bg-rose-50/30'
                                }
                              `}
                            >
                               <X className={`w-3.5 h-3.5 transition-transform duration-300 ${checked ? 'scale-100' : 'scale-50'}`} strokeWidth={3} />
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>
              )}

              {/* Add Habit Row */}
              <div className="flex border-t border-zinc-200 bg-zinc-50/50">
                <div className="w-32 sm:w-64 flex-shrink-0 p-2 sm:p-4 pl-4 sm:pl-6 sticky left-0 z-30 bg-zinc-50 shadow-[1px_0_5px_-2px_rgba(0,0,0,0.05)]">
                  <form onSubmit={handleAddHabit} className="flex flex-col gap-2 sm:gap-3">
                    <div className="flex items-center gap-2 relative">
                      <input 
                        type="text" 
                        value={newHabitText}
                        onChange={(e) => setNewHabitText(e.target.value)}
                        placeholder="New..." 
                        className="flex-1 bg-white border border-zinc-200 rounded-md px-2 py-1.5 text-xs sm:text-sm focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-400 outline-none placeholder:text-zinc-400 shadow-sm transition-all"
                      />
                      <button 
                        type="submit"
                        disabled={!newHabitText.trim()}
                        className="bg-zinc-900 hover:bg-zinc-800 text-white p-1.5 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm flex-shrink-0"
                      >
                        <Plus className="w-4 h-4" />
                      </button>
                    </div>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button
                          type="button"
                          onClick={() => setNewHabitType('good')}
                          className={`py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide flex items-center justify-center gap-1.5 transition-all border ${newHabitType === 'good' ? 'bg-emerald-100 border-emerald-200 text-emerald-800 shadow-inner' : 'bg-white border-zinc-200 text-zinc-500 hover:bg-zinc-50 hover:border-zinc-300'}`}
                        >
                          <Leaf className="w-3 h-3" /> <span className="hidden sm:inline">Build</span>
                        </button>
                        <button
                          type="button"
                          onClick={() => setNewHabitType('bad')}
                          className={`py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide flex items-center justify-center gap-1.5 transition-all border ${newHabitType === 'bad' ? 'bg-rose-100 border-rose-200 text-rose-800 shadow-inner' : 'bg-white border-zinc-200 text-zinc-500 hover:bg-zinc-50 hover:border-zinc-300'}`}
                        >
                          <Skull className="w-3 h-3" /> <span className="hidden sm:inline">Break</span>
                        </button>
                    </div>
                  </form>
                </div>
                <div className="flex-1 bg-zinc-50/50 border-l border-zinc-200 min-w-[1000px]"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* --- ANALYTICS DASHBOARD --- */}
      <div className="w-full max-w-[1400px] grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 sm:gap-6">
        
        {/* 1. Momentum Chart */}
        <div className="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 h-64 flex flex-col shadow-sm border border-zinc-200">
          <div className="flex justify-between items-start mb-4">
            <div className="flex items-center gap-2">
              <div className="p-1.5 bg-emerald-50 rounded-md"><Activity className="w-4 h-4 text-emerald-600" /></div>
              <div>
                <h3 className="text-sm font-semibold text-zinc-900">Momentum</h3>
                <p className="text-xs text-zinc-500">Good habit completion %</p>
              </div>
            </div>
            <div className="text-2xl font-bold text-emerald-600">
               {Math.round(trendData.reduce((a,b)=>a+b,0) / (trendData.filter(x=>x>0).length || 1))}%
            </div>
          </div>
          <div className="flex-1 w-full relative">
            <svg className="w-full h-full overflow-visible" viewBox="0 0 280 120" preserveAspectRatio="none">
              <defs>
                <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stopColor="#10b981" stopOpacity="0.2" />
                  <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                </linearGradient>
              </defs>
              <line x1="0" y1="0" x2="260" y2="0" stroke="#f4f4f5" strokeWidth="1" />
              <text x="265" y="5" className="text-[8px] fill-zinc-300" alignmentBaseline="middle">100%</text>
              <line x1="0" y1="50" x2="260" y2="50" stroke="#f4f4f5" strokeWidth="1" />
              <text x="265" y="55" className="text-[8px] fill-zinc-300" alignmentBaseline="middle">50%</text>
              <line x1="0" y1="100" x2="260" y2="100" stroke="#f4f4f5" strokeWidth="1" />
              <text x="265" y="105" className="text-[8px] fill-zinc-300" alignmentBaseline="middle">0%</text>
              <path d={getTrendPath()} fill="url(#chartGradient)" />
              <path d={getTrendLine()} fill="none" stroke="#10b981" strokeWidth="2" vectorEffect="non-scaling-stroke" />
              <text x="0" y="115" className="text-[8px] fill-zinc-400" textAnchor="start">Day 1</text>
              <text x="130" y="115" className="text-[8px] fill-zinc-400" textAnchor="middle">Day 15</text>
              <text x="260" y="115" className="text-[8px] fill-zinc-400" textAnchor="end">Day {daysInMonth}</text>
            </svg>
          </div>
        </div>

        {/* 2. Resistance Chart */}
        <div className="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 h-64 flex flex-col shadow-sm border border-zinc-200">
          <div className="flex justify-between items-start mb-4">
             <div className="flex items-center gap-2">
              <div className="p-1.5 bg-rose-50 rounded-md"><ShieldCheck className="w-4 h-4 text-rose-600" /></div>
              <div>
                <h3 className="text-sm font-semibold text-zinc-900">Resistance</h3>
                <p className="text-xs text-zinc-500">Bad habit incidents</p>
              </div>
            </div>
            <div className="text-2xl font-bold text-rose-600">
               {totalIncidents} <span className="text-xs font-normal text-zinc-400">slips</span>
            </div>
          </div>
          <div className="flex-1 w-full flex items-end gap-1 relative pt-4 border-b border-zinc-100">
             {badHabitTrendData.map((count, i) => {
               const heightPct = Math.min((count / (badHabits.length || 1)) * 100, 100);
               return (
                 <div key={i} className="flex-1 flex flex-col justify-end group relative h-full">
                   <div 
                    className={`w-full min-w-[4px] rounded-t-sm transition-all duration-500 ${count > 0 ? 'bg-rose-400' : 'bg-zinc-100'}`}
                    style={{ height: `${count > 0 ? heightPct : 5}%` }}
                   ></div>
                 </div>
               );
             })}
             <div className="absolute bottom-[5%] left-0 right-0 border-b border-dashed border-emerald-300 opacity-50 pointer-events-none"></div>
             <span className="absolute right-0 bottom-[6%] text-[9px] text-emerald-500 font-medium">Target (0)</span>
          </div>
          <div className="flex justify-between text-[10px] text-zinc-400 mt-2">
             <span>Day 1</span>
             <span>Day {daysInMonth}</span>
          </div>
        </div>

         {/* 3. Progress Donut */}
         <div className="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 h-64 flex flex-col shadow-sm border border-zinc-200">
           <div className="flex justify-between items-start">
             <div className="flex items-center gap-2">
                <div className="p-1.5 bg-indigo-50 rounded-md"><TrendingUp className="w-4 h-4 text-indigo-600" /></div>
                <h3 className="text-sm font-semibold text-zinc-900">Monthly Goal</h3>
             </div>
             <span className="text-xs bg-zinc-100 px-2 py-1 rounded-full text-zinc-500 font-medium">{monthlyCompletionRate}%</span>
           </div>
           <div className="flex-1 flex items-center justify-center relative">
              <div className="relative w-32 h-32">
                 <svg className="w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <path className="text-zinc-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                    <path className="text-indigo-600 transition-all duration-1000 ease-out" 
                      strokeDasharray={`${monthlyCompletionRate}, 100`}
                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" />
                 </svg>
                 <div className="absolute inset-0 flex items-center justify-center flex-col">
                    <span className="text-xl font-bold text-zinc-900">{totalCompleted}</span>
                    <span className="text-[10px] text-zinc-400 uppercase font-bold tracking-wider">Checks</span>
                 </div>
              </div>
           </div>
        </div>

        {/* 4. Highlights */}
        <div className="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 h-64 flex flex-col shadow-sm border border-zinc-200">
           <div className="flex items-center gap-2 mb-6">
              <div className="p-1.5 bg-amber-50 rounded-md"><Trophy className="w-4 h-4 text-amber-600" /></div>
              <h3 className="text-sm font-semibold text-zinc-900">Highlights</h3>
           </div>

           <div className="space-y-4">
             <div className="bg-zinc-50 rounded-xl p-4 flex items-center justify-between group hover:bg-amber-50/50 transition-colors">
                <div>
                   <p className="text-[10px] text-zinc-400 font-bold uppercase tracking-wider mb-1">Strongest Habit</p>
                   <p className="font-bold text-zinc-800 truncate max-w-[140px]">{bestHabit.label.split(' ')[0]}</p>
                </div>
                <div className="text-right">
                   <span className="text-lg font-bold text-amber-600">{bestHabit.score}%</span>
                </div>
             </div>
             <div className="bg-zinc-50 rounded-xl p-4 flex items-center justify-between group hover:bg-emerald-50/50 transition-colors">
                <div>
                   <p className="text-[10px] text-zinc-400 font-bold uppercase tracking-wider mb-1">Best Streak</p>
                   <p className="font-bold text-zinc-800">Current Month</p>
                </div>
                <div className="text-right">
                   <span className="text-lg font-bold text-emerald-600">{daysInMonth} <span className="text-xs">days</span></span>
                </div>
             </div>
           </div>
        </div>

      </div>

      <style jsx>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
}
