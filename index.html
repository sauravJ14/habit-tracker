<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monk Mode Habit Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown parser for nice AI output -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-green: #6aa84f;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --header-bg: #f8f9fa;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .main-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .month-badge {
            background: #e6f4ea;
            color: var(--primary-green);
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .controls { display: flex; gap: 10px; }

        button {
            padding: 8px 16px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #3c4043;
            transition: all 0.2s;
        }

        button:hover { background-color: #f1f3f4; border-color: #cfd1d4; }
        button.danger { color: #d93025; border-color: #f28b82; }
        button.danger:hover { background-color: #fce8e6; }

        .btn-ai {
            background: linear-gradient(135deg, #6aa84f 0%, #4ca84f 100%);
            color: white;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-ai:hover {
            background: linear-gradient(135deg, #5a983f 0%, #3c983f 100%);
            box-shadow: 0 2px 5px rgba(106, 168, 79, 0.3);
        }

        /* --- TRACKER GRID --- */
        .tracker-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            padding: 0;
        }

        .table-scroll {
            overflow-x: auto;
            width: 100%;
            padding-bottom: 5px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            white-space: nowrap;
            font-size: 13px;
        }

        th, td {
            border: 1px solid var(--border-color);
            text-align: center;
            height: 36px;
            min-width: 36px;
        }

        /* Sticky Habit Column */
        th:first-child, td:first-child {
            text-align: left;
            min-width: 200px;
            padding-left: 16px;
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 10;
            border-right: 2px solid #e0e0e0;
            font-weight: 500;
        }

        th:first-child { background: var(--header-bg); z-index: 20; }
        th { background: var(--header-bg); color: var(--text-secondary); font-weight: 600; }

        /* Checkboxes */
        td.check-cell { cursor: pointer; transition: background 0.1s; }
        td.check-cell:hover { background-color: #f8f9fa; }
        input[type="checkbox"] {
            accent-color: var(--primary-green);
            width: 16px; height: 16px; cursor: pointer;
        }

        /* Stats Row Styling */
        .stats-row td { font-weight: 600; font-size: 12px; }
        .stats-row.progress td { color: var(--text-secondary); }
        
        /* --- DASHBOARD GRID --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-stat {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-green);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Sparkline inside table */
        .spark-bar {
            background: #eee; height: 100%; width: 100%; position: relative;
        }
        .spark-fill {
            background: var(--primary-green); height: 100%; width: 0%; transition: width 0.5s;
        }
        .spark-text {
            position: absolute; width: 100%; text-align: center; top: 50%; transform: translateY(-50%); font-size: 10px; color: #000; opacity: 0.7;
        }

        /* AI Report Styling */
        #ai-coach-content {
            background: #f8fcf8;
            border: 1px solid #e6f4ea;
            border-radius: 8px;
            padding: 20px;
            min-height: 100px;
            font-size: 14px;
            line-height: 1.6;
            color: #373a3c;
        }
        #ai-coach-content h3 { margin-top: 0; color: #2d5e2e; }
        #ai-coach-content ul { padding-left: 20px; }
        #ai-coach-content li { margin-bottom: 8px; }

        /* Modal */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        #modal-box {
            background: white; padding: 24px; border-radius: 8px; width: 320px; text-align: center;
        }
        .modal-actions { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .main-container { gap: 16px; }
        }
    </style>
</head>
<body>

<div class="main-container">
    
    <!-- Header -->
    <div class="header">
        <h1>November Tracker <span class="month-badge">Monk Mode</span></h1>
        <div class="controls">
            <button onclick="copyStats()">Share Stats</button>
            <button class="danger" onclick="confirmReset()">Reset</button>
        </div>
    </div>

    <!-- The Big Tracker -->
    <div class="tracker-card">
        <div class="table-scroll">
            <table id="habitTable">
                <thead>
                    <tr id="headerRow">
                        <th>Habits</th>
                        <!-- Dates inserted by JS -->
                        <th style="min-width: 60px; background: #f8f9fa;">Goal</th>
                        <th style="min-width: 60px; background: #f8f9fa;">Done</th>
                        <th style="min-width: 100px; background: #f8f9fa;">Progress</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Habits inserted by JS -->
                </tbody>
                <tfoot id="tableFooter">
                    <!-- Stats inserted by JS -->
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="dashboard-grid">

        <!-- AI Coach Card (Full Width) -->
        <div class="chart-card full-width">
            <div class="chart-header">
                <span class="chart-title">AI Performance Coach ‚ú®</span>
                <button class="btn-ai" onclick="generateAIReport()">
                    <span>Analyze My Discipline</span>
                    <span>‚ú®</span>
                </button>
            </div>
            <div id="ai-coach-content">
                <p style="color: #777; font-style: italic;">Click "Analyze My Discipline" to get a personalized performance review from Gemini 2.5.</p>
            </div>
        </div>
        
        <!-- Chart 1: Daily Consistency Trend -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">Daily Consistency Trend</span>
                <span class="chart-stat" id="avg-daily-stat">0%</span>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Habit Strength Breakdown -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">Habit Strength</span>
                <span class="chart-stat" id="best-habit-stat">-</span>
            </div>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Overall Completion -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">Month Completion</span>
                <span class="chart-stat" id="total-completion-stat">0%</span>
            </div>
            <div class="chart-container">
                <canvas id="doughnutChart"></canvas>
            </div>
        </div>

    </div>

</div>

<!-- Modal -->
<div id="modal-overlay">
    <div id="modal-box">
        <p id="modal-message">Are you sure?</p>
        <div class="modal-actions">
            <button onclick="closeModal()">Cancel</button>
            <button class="danger" onclick="performReset()">Yes, Reset</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const daysInMonth = 30; // November
    const habits = [
        "Wake up at 05:00 ‚è∞",
        "Gym ·ï¶(√≤_√≥Àá)·ï§",
        "Reading / Learning üìñ",
        "Day Planning üóìÔ∏è",
        "Budget Tracking üí∞",
        "Project Work üéØ",
        "No Alcohol üö´",
        "Social Media Detox üåø",
        "Goal Journaling ‚úçÔ∏è",
        "Cold Shower üßä"
    ];

    // State
    let habitData = JSON.parse(localStorage.getItem('monkModeData_v4')) || {};
    
    // Chart Instances
    let trendChart, barChart, doughnutChart;

    // --- INIT ---
    function init() {
        renderTable();
        initCharts();
        updateAll();
    }

    function renderTable() {
        const headerRow = document.getElementById('headerRow');
        const tableBody = document.getElementById('tableBody');
        const footer = document.getElementById('tableFooter');
        const goalHeader = headerRow.children[1];

        // 1. Header Dates
        for(let i=1; i<=daysInMonth; i++) {
            let th = document.createElement('th');
            th.innerText = i;
            headerRow.insertBefore(th, goalHeader);
        }

        // 2. Habit Rows
        habits.forEach((habit, idx) => {
            let tr = document.createElement('tr');
            
            // Name
            let tdName = document.createElement('td');
            tdName.innerText = habit;
            tr.appendChild(tdName);

            // Checkboxes
            for(let d=1; d<=daysInMonth; d++) {
                let td = document.createElement('td');
                td.className = 'check-cell';
                td.onclick = (e) => {
                    if(e.target.type !== 'checkbox') {
                        let cb = td.querySelector('input');
                        cb.checked = !cb.checked;
                        handleCheck(idx, d, cb.checked);
                    }
                };
                
                let cb = document.createElement('input');
                cb.type = 'checkbox';
                if(habitData[`${idx}-${d}`]) cb.checked = true;
                cb.onchange = (e) => handleCheck(idx, d, e.target.checked);
                
                td.appendChild(cb);
                tr.appendChild(td);
            }

            // Analysis Cols (FIXED: Created via DOM to preserve Event Listeners)
            
            // Goal
            let tdGoal = document.createElement('td');
            tdGoal.style.fontWeight = 'bold';
            tdGoal.style.color = '#666';
            tdGoal.innerText = daysInMonth;
            tr.appendChild(tdGoal);

            // Actual
            let tdActual = document.createElement('td');
            tdActual.className = 'row-actual';
            tdActual.style.fontWeight = 'bold';
            tdActual.innerText = '0';
            tr.appendChild(tdActual);

            // Progress
            let tdProgress = document.createElement('td');
            tdProgress.innerHTML = `
                <div class="spark-bar">
                    <div class="spark-fill"></div>
                    <div class="spark-text">0%</div>
                </div>
            `;
            tr.appendChild(tdProgress);

            tableBody.appendChild(tr);
        });

        // 3. Footer Rows
        createFooterRow(footer, "Daily Success %", "stats-progress", "%");
        createFooterRow(footer, "Done", "stats-done", "");
        createFooterRow(footer, "Not Done", "stats-missed", "");
    }

    function createFooterRow(footer, title, type, suffix) {
        let tr = document.createElement('tr');
        tr.className = `stats-row ${type}`;
        let tdTitle = document.createElement('td');
        tdTitle.innerText = title;
        tr.appendChild(tdTitle);

        for(let i=1; i<=daysInMonth; i++) {
            let td = document.createElement('td');
            td.className = `day-stat-${i}-${type}`;
            td.innerText = `0${suffix}`;
            tr.appendChild(td);
        }
        // Spacers
        tr.appendChild(document.createElement('td'));
        tr.appendChild(document.createElement('td'));
        tr.appendChild(document.createElement('td'));
        
        footer.appendChild(tr);
    }

    // --- LOGIC ---

    function handleCheck(habitIdx, day, isChecked) {
        if(isChecked) habitData[`${habitIdx}-${day}`] = true;
        else delete habitData[`${habitIdx}-${day}`];
        
        localStorage.setItem('monkModeData_v4', JSON.stringify(habitData));
        updateAll();
    }

    function updateAll() {
        // 1. Calculate Table Data
        const rows = document.querySelectorAll('#tableBody tr');
        let dailyCounts = new Array(daysInMonth + 1).fill(0);
        let habitCounts = new Array(habits.length).fill(0);
        let totalChecks = 0;

        // Habit horizontal stats
        rows.forEach((row, hIdx) => {
            let hCount = 0;
            for(let d=1; d<=daysInMonth; d++) {
                if(habitData[`${hIdx}-${d}`]) {
                    hCount++;
                    dailyCounts[d]++;
                    totalChecks++;
                }
            }
            habitCounts[hIdx] = hCount;

            // Update row UI
            row.querySelector('.row-actual').innerText = hCount;
            const pct = Math.round((hCount/daysInMonth)*100);
            row.querySelector('.spark-fill').style.width = `${pct}%`;
            row.querySelector('.spark-text').innerText = `${pct}%`;
        });

        // Daily vertical stats
        for(let d=1; d<=daysInMonth; d++) {
            const count = dailyCounts[d];
            const pct = Math.round((count / habits.length) * 100);
            
            // Update Footer UI
            const cell = document.querySelector(`.day-stat-${d}-stats-progress`);
            if(cell) {
                cell.innerText = `${pct}%`;
                // Color logic
                if(pct === 100) { cell.style.background = '#dff6dd'; cell.style.color = '#0d652d'; }
                else if(pct > 0) { cell.style.background = '#f1f3f4'; cell.style.color = '#5f6368'; }
                else { cell.style.background = 'transparent'; }
            }

            const doneCell = document.querySelector(`.day-stat-${d}-stats-done`);
            if(doneCell) doneCell.innerText = count;
            
            const missedCell = document.querySelector(`.day-stat-${d}-stats-missed`);
            if(missedCell) missedCell.innerText = habits.length - count;
        }

        // 2. Update Charts
        updateCharts(dailyCounts, habitCounts, totalChecks);
    }

    // --- AI FUNCTIONALITY ---
    async function generateAIReport() {
        const contentDiv = document.getElementById('ai-coach-content');
        contentDiv.innerHTML = `<p style="color: #6aa84f; font-weight: bold; animation: pulse 1.5s infinite;">üß† Analyzing your habit patterns... please wait.</p>`;

        // 1. Prepare Data Summary for AI
        let reportData = "Habit Summary:\n";
        habits.forEach((habit, idx) => {
            let count = 0;
            for(let d=1; d<=daysInMonth; d++) {
                if(habitData[`${idx}-${d}`]) count++;
            }
            reportData += `- ${habit}: ${count}/${daysInMonth} days completed.\n`;
        });

        const systemPrompt = `
            You are a strict but encouraging high-performance coach for a user in 'Monk Mode'. 
            Review their habit tracker data. 
            1. Identify the habit they are neglecting the most.
            2. Give 3 specific, actionable, no-nonsense tips to fix their routine.
            3. End with a short, punchy motivational quote.
            Format the response in Markdown. Keep it concise.
        `;

        const userQuery = `Here is my habit data for this month: \n\n${reportData}\n\nAnalyze my discipline.`;

        try {
            const apiKey = ""; 
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                })
            });

            if (!response.ok) throw new Error('AI Busy');
            
            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            
            // Render with Markdown
            contentDiv.innerHTML = marked.parse(aiText);

        } catch (error) {
            console.error(error);
            contentDiv.innerHTML = `<p style="color: #d93025;">‚ö†Ô∏è The AI Coach is currently offline or busy. Please try again in a moment. (Error: ${error.message})</p>`;
        }
    }


    // --- CHARTS ---

    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        };

        // 1. Trend Chart
        const ctx1 = document.getElementById('trendChart').getContext('2d');
        // Create gradient
        let gradient = ctx1.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(106, 168, 79, 0.5)');
        gradient.addColorStop(1, 'rgba(106, 168, 79, 0.0)');

        trendChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                datasets: [{
                    label: 'Daily Success %',
                    data: [],
                    borderColor: '#6aa84f',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2
                }]
            },
            options: {
                ...commonOptions,
                scales: { y: { min: 0, max: 100 } }
            }
        });

        // 2. Bar Chart
        const ctx2 = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: habits,
                datasets: [{
                    label: 'Completion',
                    data: [],
                    backgroundColor: '#6aa84f',
                    borderRadius: 4
                }]
            },
            options: {
                ...commonOptions,
                indexAxis: 'y', // Horizontal bar
                scales: { x: { max: daysInMonth } }
            }
        });

        // 3. Doughnut Chart
        const ctx3 = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['Done', 'Remaining'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#6aa84f', '#e0e0e0'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '75%',
                plugins: { tooltip: { enabled: false } }
            }
        });
    }

    function updateCharts(dailyCounts, habitCounts, totalChecks) {
        // Update Trend
        const dailyPcts = dailyCounts.slice(1).map(c => Math.round((c/habits.length)*100));
        trendChart.data.datasets[0].data = dailyPcts;
        trendChart.update();
        
        const avgDaily = Math.round(dailyPcts.reduce((a,b)=>a+b,0) / daysInMonth);
        document.getElementById('avg-daily-stat').innerText = `${avgDaily}%`;

        // Update Bar
        barChart.data.datasets[0].data = habitCounts;
        barChart.update();

        // Find best habit
        const bestIdx = habitCounts.indexOf(Math.max(...habitCounts));
        document.getElementById('best-habit-stat').innerText = habits[bestIdx].split(' ')[0]; // Just first word

        // Update Doughnut
        const totalPossible = daysInMonth * habits.length;
        const totalPct = Math.round((totalChecks / totalPossible) * 100);
        doughnutChart.data.datasets[0].data = [totalChecks, totalPossible - totalChecks];
        doughnutChart.update();
        document.getElementById('total-completion-stat').innerText = `${totalPct}%`;
    }

    // --- UTILS ---
    function confirmReset() {
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }
    function performReset() {
        localStorage.removeItem('monkModeData_v4');
        habitData = {};
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateAll();
        closeModal();
    }
    function copyStats() {
        const pct = document.getElementById('total-completion-stat').innerText;
        const text = `November Monk Mode Update: ${pct} Completed! üéØ`;
        navigator.clipboard.writeText(text);
        alert('Stats copied to clipboard: ' + text);
    }

    init();

</script>

<style>
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
</style>
</body>
</html>
